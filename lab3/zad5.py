# Zaimplementuj algorytm deszyfrowania ElGamala na krzywej eliptycznej.
# Dane: C= [C1, C2]PM, KA= [E= [A, B, p], p, x, Q, P] - tajny
# Wynik: PM= (x, y)âˆˆE(Fp)



def effective_power(b, k, n):
    y = 1
    binary = list(reversed(bin(k)[2:]))
    i = len(binary) - 1
    while i >= 0:
        y = (y ** 2) % n
        if binary[i] == "1":
            y = (y * b) % n
        i = i - 1
    return y


def reverse_element(n, b):
    A = n
    B = b
    U = 0
    V = 1
    while B != 0:
        q = A // B
        temp = A
        A = B
        B = temp + (-q * B)
        temp = U
        U = V
        V = temp + (-q * V)
    if U < 0:
        return n + U
    return U


def opposed_point(x, y, p):
    return x, p-y


def sum_points(x1: int, y1: int, x2: int, y2: int, A: int, B: int, p: int):
    if (x1, y1) == opposed_point(x2, y2, p):
        return None, None
    elif x1 is None and y1 is None:
        return x2, y2
    elif x2 is None and y2 is None:
        return x1, y1
    elif x1 == x2 and y1 == y2:
        fi = ((3 * effective_power(x1, 2, p) + A) * reverse_element(p, (2*y1) % p)) % p
        x3 = (effective_power(fi, 2, p) - 2*x1) % p
        return x3, (fi * (x1 - x3) - y1) % p
    else:
        fi = ((y2 - y1) * reverse_element(p, (x2 - x1) % p)) % p
        x3 = (effective_power(fi, 2, p) - x1 - x2) % p
        return x3, (fi * (x1 - x3) - y1) % p


def multiple_point(x, y, n, a, b, p):
    N = n
    x_q = x
    y_q = y
    x_r = None
    y_r = None
    while N > 0:
        if N % 2 == 1:
            x_r, y_r = sum_points(x_r, y_r, x_q, y_q, a, b, p)
            N = N - 1
        else:
            x_q, y_q = sum_points(x_q, y_q, x_q, y_q, a, b, p)
            N = N // 2
    return x_r, y_r


def decode_c(x_c1, y_c1, x_c2, y_c2, A, B, p, x):
    x_xc1, y_xc1 = multiple_point(x_c1, y_c1, x, A, B, p)
    x_xc1, y_xc1 = opposed_point(x_xc1, y_xc1, p)
    return sum_points(x_c2, y_c2, x_xc1, y_xc1, A, B, p)


print(decode_c(2500131221136318238633687570230117140911217457797968581385667931940002678940849111039281066,
               4524285902566896540097240019235501613483401678359238984290904089801379981757400005106055642,
               4420076091146643636253945503255224199542789588341941034004355123212261410466754354388404724,
               3976523857481223428509195335137970530947066674291577980939003498906439704152946202534176853,
               7148657790401888117936437873048886260637577263876304131439817880330747101829619895814984078,
               3268840620758163770229719479317063048758434569863646568374795309054038018228737135314631458,
               7289594731814016394826558288118917561020775018399649854657170488920055392762783288241856511,
               260254608725076196009210334664033417987212248368280748887474554517403356390
))

# c1 = ( 3801408038035483891687048974661217143464707280667020277954596345515017882569724311659025,
#        3166286592509596362097970704229927192809922329639449816252656796669956109713202627620445
#        )
# c2 = ( 12375572704791188893273134467942452144929666676976315210466024710454758544393989360122561,
#        12087312523582875804495768011251808944929864685937383719058548447992788206355178849753813
#        )

# (6153674022008798356316564924518038486173430477193690509188649428411135000528237176635080, 13662250368919734312645269641696052525758616995978154525472476570360908683151586285505731, 7574459824525130922130084328364001828184308480826540967337773136105539912954134053507591, 9364149714873442310772909282805174135226211360047922290706296997162435584369029972529189)
